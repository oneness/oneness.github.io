<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://www.birkey.co/rss.xml"
      title="RSS feed for https://www.birkey.co/"/>
<title>Datafy and tap> in Clojure 1.10</title>
<meta name="author" content="Kasim Tuman">
  <meta name="referrer" content="no-referrer">
  <link href= "static/style.css" rel="stylesheet" type="text/css" />
  <link rel="icon" href="static/favicon.ico">
  <link rel="apple-touch-icon-precomposed" href="static/birkey_logo.png">
  <link rel="msapplication-TitleImage" href="static/birkey_logo.png">
  <link rel="msapplication-TitleColor" href="#0141ff">
  <script src="static/katex.min.js"></script>
  <script src="static/auto-render.min.js"></script>
  <link rel="stylesheet" href="static/katex.min.css">
  <script>document.addEventListener("DOMContentLoaded", function() { renderMathInElement(document.body); });</script>
  <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8">
  <meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1"></head>
<body>
<div id="preamble" class="status"><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="https://www.birkey.co/index.html" style="text-decoration: none;"><b>KASIM TUMAN'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<a class="title" href="https://www.birkey.co/resume/resume.html">ABOUT</a> &nbsp;<a class="title" href="https://github.com/oneness">GITHUB</a> &nbsp;<a class="title" href="https://www.birkey.co/rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/ktuman">DONATE</a></div></div>
</center><br><br>
<div style="margin-bottom: 3ch;text-transform: none;">
</div>
<div class='heading'>Kasim Tuman's Website</div><hr/>
<p>This is my personal website. You can find here my codes and ideas about programming. </p></div>
<div id="content">
<div class="post-date">26 Oct 2018</div><h1 class="post-title"><a href="https://www.birkey.co/2018-10-26-datafy-and-tap>-in-clojure-1.10.html">Datafy and tap> in Clojure 1.10</a></h1>
<p>
I noticed couple of new features being added to Clojure 1.10. One is
<b>tap</b>, which is added to the core ns, and the other is <b>datafy</b>, which
is added to clojure.datafy ns.  
</p>

<p>
<b>tap</b> essentially is an atom holding set of fns of single arity, which
will be asynchronously called on any value you you send via
<b>tap&gt;</b>. You can add a single arity fn to the <b>tap</b> via <b>(add-tap f)</b>
and remove the fn via <b>(remove-tap f</b>).  Note that you have to
remember the fn you added so you can remove it. Otherwise, you have no
way of removing the fn, which is an inconvenience but there might be a
reason why it is the way it is. I am not sure about its intended use
cases but I know it comes handy when you have a set of transformation
(<b>important: order of those transformation should not matter</b>) that you
would like to apply to any value asynchronously. I can think of
following uses cases for tap:
</p>
<ul class="org-ul">
<li>Collecting some sort of diagnostic information about running system.</li>
<li>Streaming serious of values to be processed and routed to a sink somewhere.</li>
<li>May be used (rather abused) to execute some code? hope not.</li>
</ul>
<p>
Enough being said, let us see with a simple example to cover first
uses case I said above. 
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #7f7f7f;">(</span><span style="color: #a020f0;">def</span> <span style="color: #a0522d;">context</span> <span style="color: #7f7f7f;">(</span>StringBuilder.<span style="color: #7f7f7f;">))</span>

<span style="color: #7f7f7f;">(</span><span style="color: #a020f0;">defn</span>  <span style="color: #0000ff;">&#59780;context</span> <span style="color: #7f7f7f;">[</span>x<span style="color: #7f7f7f;">]</span>
  <span style="color: #7f7f7f;">(</span><span style="color: #a020f0;">doto</span> context
    <span style="color: #7f7f7f;">(</span>.append x<span style="color: #7f7f7f;">)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">Then let us add above fn to the tapset</span>
<span style="color: #7f7f7f;">(</span>add-tap  &#59780;context<span style="color: #7f7f7f;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">Then from any where of our running code, we can do:</span>
<span style="color: #7f7f7f;">(</span>tap&gt; <span style="color: #8b2252;">"  &#59744;  &#59744;* tap start   &#59744;  &#59744;**</span><span style="color: #8b2252; font-weight: bold;">\n</span><span style="color: #8b2252;"> "</span><span style="color: #7f7f7f;">)</span>
<span style="color: #7f7f7f;">(</span>tap&gt; <span style="color: #8b2252;">"runing  &#59793;  &#59793;  &#59793;  &#59793;  &#59793;  &#59793;  &#59793; &#59792;</span><span style="color: #8b2252; font-weight: bold;">\n</span><span style="color: #8b2252;">"</span><span style="color: #7f7f7f;">)</span>
<span style="color: #7f7f7f;">(</span>tap&gt; <span style="color: #8b2252;">"  &#59744;  &#59744;* tap end   &#59744;  &#59744;  &#59744;*</span><span style="color: #8b2252; font-weight: bold;">\n</span><span style="color: #8b2252;"> "</span><span style="color: #7f7f7f;">)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">It will be executed in a separate dedicated thread and will not</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">block or interfere with our running code. Then we print out the context:</span>
<span style="color: #7f7f7f;">(</span>str context<span style="color: #7f7f7f;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">which results in:</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;"> &#59744;  &#59744;* tap start   &#59744;  &#59744;**</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">runing  &#59793;  &#59793;  &#59793;  &#59793;  &#59793;  &#59793;  &#59793; &#59792;</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;"> &#59744;  &#59744;* tap end   &#59744;  &#59744;  &#59744;*</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">Remember to remove the  &#59780;context fn once you are done with that session:</span>
<span style="color: #7f7f7f;">(</span>remove-tap  &#59780;context<span style="color: #7f7f7f;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">If there is no fn added to the tap, any values you send to tap will be discarded.</span>
<span style="color: #7f7f7f;">(</span>tap&gt; <span style="color: #8b2252;">"your magic"</span><span style="color: #7f7f7f;">)</span> <span style="color: #b22222;">;; </span><span style="color: #b22222;">your magic will be discarded.</span>

</pre>
</div>

<p>
The other one I noticed is <b>datafy</b>, which I am more excited about. I
am already using it to find out about java classes members, methods
and its object graph. Let us take a java class <b>String</b> as an example.
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #7f7f7f;">(</span>require '<span style="color: #7f7f7f;">[</span>clojure.datafy <span style="color: #008b8b;">:as</span> d<span style="color: #7f7f7f;">])</span>
<span style="color: #7f7f7f;">(</span><span style="color: #228b22;">d</span>/datafy String<span style="color: #7f7f7f;">)</span> <span style="color: #b22222;">;; </span><span style="color: #b22222;">which will print all about its members in a nice clojure ds</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">let us write an fn to give use any member that we would like to find more about:</span>
<span style="color: #7f7f7f;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">member-lookup</span> <span style="color: #7f7f7f;">[</span>class member<span style="color: #7f7f7f;">]</span>
  <span style="color: #7f7f7f;">( </span><span style="color: #a020f0;"> &#59781;</span> class
       <span style="color: #228b22;">d</span>/datafy
       <span style="color: #008b8b;">:members</span>
       <span style="color: #7f7f7f;">(</span>filter <span style="color: #7f7f7f;">(</span><span style="color: #a020f0;">fn</span>  <span style="color: #7f7f7f;">&#60032;</span>k v <span style="color: #7f7f7f;">&#60033;</span> <span style="color: #7f7f7f;">(</span>= <span style="color: #7f7f7f;">(</span>symbol member<span style="color: #7f7f7f;">)</span> k<span style="color: #7f7f7f;">)))))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">then use it to find about "intern"</span>
<span style="color: #7f7f7f;">(</span>member-lookup String <span style="color: #8b2252;">"intern"</span><span style="color: #7f7f7f;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">returns:</span>
<span style="color: #7f7f7f;">([</span>intern
  <span style="color: #7f7f7f;">[</span>{<span style="color: #008b8b;">:name</span> intern,
    <span style="color: #008b8b;">:return-type</span> java.lang.String,
    <span style="color: #008b8b;">:declaring-class</span> java.lang.String,
    <span style="color: #008b8b;">:parameter-types</span> <span style="color: #7f7f7f;">[]</span>,
    <span style="color: #008b8b;">:exception-types</span> <span style="color: #7f7f7f;">[]</span>,
    <span style="color: #008b8b;">:flags</span>  &#59682;<span style="color: #008b8b;">:public</span> <span style="color: #008b8b;">:native</span>}} <span style="color: #7f7f7f;">&#60033;)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">One can learn a lot about this method from above ds. "intern" is a</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">public native method that takes no argument, called on string object</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">and returns string like this:</span>
<span style="color: #7f7f7f;">(</span>.intern <span style="color: #8b2252;">"test"</span><span style="color: #7f7f7f;">)</span> <span style="color: #b22222;">;;  </span><span style="color: #b22222;">&#59908; "test"</span>

</pre>
</div>

<p>
This means we can use above information to create Clojure fns on the
fly for java inter-op. One great use case would be to generate Clojure
fns out of AWS Java SDK, which I might do if time permits.
</p>
<div class="taglist"><a href="https://www.birkey.co/tags.html">Tags</a>: <a href="https://www.birkey.co/tag-clojure.html">clojure</a> </div></div>
<div id="postamble" class="status"><br><center>
    <div style="display: inline-block; vertical-align:middle;"></div>
</div>
</body>
</html>
